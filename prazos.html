<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Contador de Prazos Cíveis — TJGO</title>
  <style>
    :root{
      --paper:#f8f6f2; --paper-3:#eee9e1; --card:#ffffff;
      --ink:#2b2b2b; --sepia:#7a6f61; --graphite:#3a3a3a;
      --line:#e3ded6; --line-2:#d8d1c4;
      --useful:#4d6b4d; --holiday:#7a6f61; --recess:#6a1f1f; --ash:#8a6d3b;
      --row:#fbf9f5; --row2:#f5f1ea; --hl:#f1ede5; --bad:var(--recess);
    }

    *{box-sizing:border-box; margin:0; padding:0;}
    html,body{height:100%; overflow-x:hidden;}
    body{
      background:var(--paper); color:var(--ink);
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      padding:16px 16px 24px;
    }

    /* Container principal compacto */
    .container {
      max-width:1000px;
      margin:0 auto;
    }

    /* Título compacto */
    .title {
      font-size:1.5rem;
      font-weight:800;
      color:var(--graphite);
      margin-bottom:12px;
      text-align:center;
    }

    /* Informações legais colapsáveis */
    .legal-info {
      background:var(--paper-3);
      border-radius:12px;
      padding:12px 16px;
      margin-bottom:16px;
      font-size:.85rem;
      line-height:1.5;
      color:var(--sepia);
    }
    .legal-toggle {
      cursor:pointer;
      font-weight:700;
      color:var(--graphite);
      user-select:none;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .legal-content {
      margin-top:10px;
      display:none;
    }
    .legal-content.show {
      display:block;
    }
    .legal-toggle::before {
      content:"▶";
      font-size:.7rem;
      transition:transform .2s;
    }
    .legal-toggle.open::before {
      transform:rotate(90deg);
    }

    /* Card principal */
    .card{
      background:var(--card); 
      border-radius:16px; 
      border:1px solid var(--line);
      box-shadow:0 4px 12px rgba(2,12,27,.06); 
      padding:20px;
      margin-bottom:16px;
    }

    /* Grid responsivo */
    .grid{
      display:grid; 
      grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); 
      gap:14px;
      margin-bottom:14px;
    }
    
    .field{
      display:flex; 
      flex-direction:column; 
      gap:6px;
    }
    
    label{
      font-size:.9rem; 
      color:#4a4743; 
      font-weight:600;
    }
    
    /* Melhora de Acessibilidade: Foco visível */
    input:focus, select:focus, button:focus {
      outline: 2px solid var(--graphite);
      outline-offset: 1px;
      border-color: var(--graphite);
    }

    /* Correção: O seletor abaixo estava faltando no seu código */
    input[type="date"], select, input[type="number"] {
      width:100%; 
      padding:11px 13px; 
      border:1px solid #e5e1db; 
      border-radius:10px; 
      font-size:.95rem;
      background:#fff; 
      /* outline:none; -> Removido para permitir navegação visual */
    }

    /* Ações */
    .actions{
      display:flex; 
      align-items:center; 
      gap:10px; 
      flex-wrap:wrap;
      margin-bottom:14px;
    }

    .btn{
      padding:11px 16px; 
      border-radius:10px; 
      cursor:pointer; 
      font-weight:700;
      border:1px solid transparent; 
      letter-spacing:.3px;
      font-size:.9rem;
      transition:all .2s;
    }
    .btn.primary{
      background:var(--graphite); 
      color:#fff;
    }
    .btn.secondary{
      background:var(--sepia); 
      color:#fff;
    }
    .btn.ghost{
      background:transparent; 
      border:1px solid #d6d0c7; 
      color:var(--ink);
    }
    .btn:hover{
      transform:translateY(-1px);
      box-shadow:0 2px 8px rgba(0,0,0,.15);
    }

    /* Chips de atalho */
    .chips{
      display:flex; 
      gap:8px; 
      flex-wrap:wrap;
    }
    .chip{
      padding:8px 12px; 
      background:transparent; 
      border:1px solid #d6d0c7;
      border-radius:999px; 
      font-weight:700; 
      cursor:pointer; 
      font-size:.85rem;
      transition:all .2s;
    }
    .chip:hover{
      background:var(--paper-3);
      transform:translateY(-1px);
    }
    .chip[data-d="5"]{border-color:var(--ash); color:var(--ash)}
    .chip[data-d="15"]{border-color:var(--useful); color:var(--useful)}
    .chip[data-d="30"]{border-color:var(--useful); color:var(--ash)}

    /* Resultado */
    .result {
      margin-top:16px;
    }
    
    .final-date{
      padding:14px 16px; 
      background:var(--hl);
      border:1px dashed var(--line-2); 
      border-radius:10px; 
      font-weight:800;
      margin-bottom:12px;
      text-align:center;
    }

    /* Tabela */
    .table-wrapper {
      max-height:350px; 
      overflow:auto; 
      border:1px solid var(--line); 
      border-radius:10px; 
      background:#fff;
      margin-top:12px;
    }
    
    table{
      width:100%; 
      border-collapse:separate; 
      border-spacing:0; 
      font-size:.88rem;
    }
    
    thead th{
      position:sticky; 
      top:0; 
      background:#fff; 
      z-index:2; 
      padding:10px 10px; 
      border-bottom:2px solid var(--line);
      font-weight:700;
      text-align:left;
    }
    
    tbody td{
      padding:9px 10px; 
      border-bottom:1px dashed #e7e2da;
    }
    
    tbody tr:nth-child(odd){background:var(--row)}
    tbody tr:nth-child(even){background:var(--row2)}
    tbody tr:hover{background:var(--hl)}

    /* Tags */
    .tag{
      padding:4px 9px; 
      border-radius:999px; 
      font-weight:700; 
      font-size:.8rem; 
      display:inline-block; 
      border:1px solid transparent;
      white-space:nowrap;
    }
    .tag.ok{background:rgba(77,107,77,.1); color:var(--useful); border-color:rgba(77,107,77,.25)}
    .tag.warn{background:rgba(122,111,97,.1); color:var(--holiday); border-color:rgba(122,111,97,.25)}
    .tag.recesso{background:rgba(106,31,31,.1); color:var(--recess); border-color:rgba(106,31,31,.25)}
    .tag.info{background:rgba(138,109,59,.1); color:var(--ash); border-color:rgba(138,109,59,.25)}

    /* Utilitários */
    .code{
      padding:2px 7px; 
      border-radius:6px; 
      border:1px solid var(--line); 
      background:#f4f1eb;
      font-family:monospace;
    }
    .danger{
      color:var(--recess); 
      font-weight:800;
    }
    .muted {
      color:#7a6f61;
      font-size:.82rem;
    }

    /* Responsividade mobile */
    @media (max-width: 640px) {
      body {
        padding:12px 12px 20px;
      }
      .title {
        font-size:1.3rem;
      }
      .grid {
        grid-template-columns:1fr;
      }
      .actions {
        flex-direction:column;
        align-items:stretch;
      }
      .btn {
        width:100%;
        text-align:center;
      }
      .chips {
        justify-content:center;
      }
      table {
        font-size:.82rem;
      }
      thead th, tbody td {
        padding:8px 6px;
      }
    }
  </style>
</head>
<body>

<div class="container">
  <h1 class="title">Contador de Prazos Cíveis — TJGO</h1>

  <div class="legal-info">
    <div class="legal-toggle" id="legalToggle">
      Regras de Contagem
    </div>
    <div class="legal-content" id="legalContent">
      <p><strong>Leitura</strong>: contagem no primeiro dia útil subsequente.</p>
      <p><strong>Expedição</strong>: D1/D2; contagem no dia útil subsequente à publicação (D2).</p>
      <p><strong>Quarta-Feira de Cinzas (QF)</strong>: não se inicia nem termina; conta-se durante o curso.</p>
      <p><strong>Recesso</strong>: 20/12 a 20/01 (inclusive); aplica-se somente dia útil.</p>
    </div>
  </div>

  <section class="card">
    <div class="grid">
      <div class="field">
        <label for="tipo">Tipo de marco inicial</label>
          <select id="tipo">
            <option value="leitura">Leitura (intimação lida)</option>
            <option value="expedicao" selected>Expedição (Projudi)</option>
          </select>
      </div>

      <div class="field">
        <label for="dataBase">Data Inicial</label>
        <input type="date" id="dataBase" />
      </div>

      <div class="field">
        <label for="dias">Dias de prazo (dias úteis)</label>
        <input type="number" id="dias" min="1" step="1" value="15"/>
      </div>
    </div>

    <div class="actions">
      <button class="btn primary" id="btnCalcular">Calcular prazo</button>
      <div class="chips">
        <button class="chip" data-d="5">5 dias</button>
        <button class="chip" data-d="15">15 dias</button>
        <button class="chip" data-d="30">30 dias</button>
      </div>
    </div>
    <p class="muted">Feriados TJGO (2023–2026), recesso, fins de semana e Quarta-feira de Cinzas com regra especial já aplicados.</p>

    <div class="result" id="resultado" style="display:none">
      <div class="final-date" id="finalDate"></div>
      <div class="actions">
        <button class="btn secondary" id="btnCopiar">Copiar resumo</button>
        <button class="btn ghost" id="btnCSV">Exportar CSV</button>
      </div>
      <div class="table-wrapper">
        <table id="tabela">
          <thead>
            <tr>
              <th>#</th>
              <th>Data</th>
              <th>Dia</th>
              <th>Tipo</th>
              <th>Observação</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <p class="muted" style="margin-top:10px;">Planilha de auditoria: todos os dias entre o marco e a data final são listados com justificativa.</p>
    </div>
  </section>
</div>

<script>
  // ---------- Utilidades de datas ----------
  const fmtBR = (d)=>{
    const pad = (n)=> String(n).padStart(2,'0');
    return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()}`;
  };
  const diaSemana = (d)=>["Dom","Seg","Ter","Qua","Qui","Sex","Sáb"][d.getDay()];
  const ymd = (d)=>{
    const pad=(n)=> String(n).padStart(2,'0');
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
  };
  const parseISO = (s)=>{
    const [Y,M,D] = s.split('-').map(Number);
    const dt = new Date(Date.UTC(Y, M-1, D));
    return new Date(dt.getUTCFullYear(), dt.getUTCMonth(), dt.getUTCDate());
  };
  const addDays = (d, n)=>{
    const nd = new Date(d);
    nd.setDate(nd.getDate()+n);
    return nd;
  };

  // ---------- Base de feriados TJGO (2023-2026) ----------
  const HOLIDAYS = new Map();
  const ASH = new Set();

  function add(name, dates, {ash=false}={}) {
    dates.forEach(s=> {
      HOLIDAYS.set(s, {name, yearTag: s.slice(0,4)});
      if(ash) ASH.add(s);
    });
  }
  function addRange(name, fromYMD, toYMD){
    let d = parseISO(fromYMD);
    const end = parseISO(toYMD);
    while(d <= end){
      HOLIDAYS.set(ymd(d), {name, yearTag: d.getFullYear().toString()});
      d = addDays(d, 1);
    }
  }

  // 2023
  add("Confraternização Universal (Feriado Nacional)", ["2023-01-01"]);
  add("Carnaval (Feriado no Tribunal e em todas as comarcas)", ["2023-02-20","2023-02-21"]);
  add("Quarta-feira de Cinzas (regra especial)", ["2023-02-22"], {ash:true});
  add("Semana Santa — Feriado no Tribunal", ["2023-04-05","2023-04-06"]);
  add("Paixão de Cristo (Feriado Nacional)", ["2023-04-07"]);
  add("Tiradentes (Feriado Nacional)", ["2023-04-21"]);
  add("Dia do Trabalho (Feriado Nacional)", ["2023-05-01"]);
  add("Nossa Senhora Auxiliadora (Feriado Municipal: Goiânia, Iporá, Leopoldo de Bulhões, Senador Canedo)", ["2023-05-24"]);
  add("Corpus Christi (Feriado Nacional)", ["2023-06-08"]);
  add("Fundação da Cidade de Goiás (Feriado no Tribunal)", ["2023-07-26"]);
  add("Independência do Brasil (Feriado Nacional)", ["2023-09-07"]);
  add("Nossa Senhora Aparecida (Feriado Nacional)", ["2023-10-12"]);
  add("Comemorativo pedra fundamental/Aniversário de Goiânia (Feriado no Tribunal)", ["2023-10-24"]);
  add("Dia do Servidor Público (Feriado Estadual)", ["2023-10-28"]);
  add("Finados (Feriado Nacional)", ["2023-11-02"]);
  add("Proclamação da República (Feriado Nacional)", ["2023-11-15"]);
  add("Dia da Justiça (Feriado no Tribunal)", ["2023-12-08"]);
  add("Natal (Feriado Nacional)", ["2023-12-25"]);
  addRange("Recesso Forense", "2023-12-20", "2024-01-20");

  // 2024
  add("Ano Novo (Feriado Nacional)", ["2024-01-01"]);
  add("Carnaval (Feriado no Tribunal e em todas as comarcas)", ["2024-02-12","2024-02-13"]);
  add("Quarta-feira de Cinzas (regra especial)", ["2024-02-14"], {ash:true});
  add("Semana Santa — Feriado no Tribunal", ["2024-03-27","2024-03-28","2024-03-29"]);
  add("Dia do Trabalho (Feriado Nacional)", ["2024-05-01"]);
  add("Nossa Senhora Auxiliadora (Feriado Municipal: TJ/Comarcas específicas)", ["2024-05-24"]);
  add("Corpus Christi (Feriado Nacional)", ["2024-05-30"]);
  add("Ponto Facultativo — PJ estadual", ["2024-05-31"]);
  add("Fundação da Cidade de Goiás (feriado de 26/07 alterado para 22/07)", ["2024-07-22"]);
  add("Aniversário de Goiânia (Feriado no Tribunal e em todas as comarcas)", ["2024-10-24"]);
  add("Dia do Servidor Público (feriado do dia 28/10 alterado para 01/11)", ["2024-11-01"]);
  add("Proclamação da República (Feriado Nacional)", ["2024-11-15"]);
  add("Dia da Consciência Negra (Feriado Nacional)", ["2024-11-20"]);
  add("Natal (Feriado Nacional)", ["2024-12-25"]);
  addRange("Recesso Forense", "2024-12-20", "2025-01-20");

  // 2025
  add("Ano Novo (Feriado Nacional)", ["2025-01-01"]);
  add("Carnaval (Feriado no Tribunal e em todas as comarcas)", ["2025-03-03","2025-03-04"]);
  add("Quarta-feira de Cinzas (regra especial)", ["2025-03-05"], {ash:true});
  add("Semana Santa — Feriado no Tribunal", ["2025-04-16","2025-04-17","2025-04-18"]);
  add("Tiradentes (Feriado Nacional)", ["2025-04-21"]);
  add("Dia do Trabalho (Feriado Nacional)", ["2025-05-01"]);
  add("Nossa Senhora Auxiliadora (Feriado Municipal: TJ/Comarcas específicas)", ["2025-05-24"]);
  add("Corpus Christi (Feriado Nacional)", ["2025-06-19"]);
  add("Fundação da Cidade de Goiás (Feriado no Tribunal)", ["2025-07-26"]);
  add("Independência do Brasil (Feriado Nacional)", ["2025-09-07"]);
  add("Nossa Senhora Aparecida (Feriado Nacional)", ["2025-10-12"]);
  add("Aniversário de Goiânia (Feriado no Tribunal e em todas as comarcas)", ["2025-10-24"]);
  add("Ponto Facultativo", ["2025-10-27"]);
  add("Dia do Servidor Público (Feriado Estadual)", ["2025-10-28"]);
  add("Finados (Feriado Nacional)", ["2025-11-02"]);
  add("Proclamação da República (Feriado Nacional)", ["2025-11-15"]);
  add("Dia da Consciência Negra (Feriado Nacional)", ["2025-11-20"]);
  add("Ponto Facultativo", ["2025-11-21"]);
  add("Dia da Justiça (Feriado — Art. 123 RITJGO)", ["2025-12-08"]);
  add("Natal (Feriado Nacional)", ["2025-12-25"]);
  addRange("Recesso Forense", "2025-12-20", "2026-01-20");

  // 2026
  add("Ano Novo (Feriado Nacional)", ["2026-01-01"]);
  add("Carnaval (Feriado no Tribunal e em todas as comarcas)", ["2026-02-16","2026-02-17"]);
  add("Quarta-feira de Cinzas (regra especial)", ["2026-02-18"], {ash:true});
  add("Semana Santa — Feriado no Tribunal", ["2026-04-01","2026-04-02","2026-04-03"]);
  add("Ponto Facultativo (ponte Tiradentes)", ["2026-04-20"]);
  add("Tiradentes (Feriado Nacional)", ["2026-04-21"]);
  add("Dia do Trabalho (Feriado Nacional)", ["2026-05-01"]);
  add("Nossa Senhora Auxiliadora (Feriado Municipal: TJ/Comarcas específicas)", ["2026-05-24"]);
  add("Corpus Christi (Feriado Nacional)", ["2026-06-04"]);
  add("Ponto Facultativo (ponte Corpus Christi)", ["2026-06-05"]);
  add("Fundação da Cidade de Goiás (Feriado no Tribunal)", ["2026-07-26"]);
  add("Independência do Brasil (Feriado Nacional)", ["2026-09-07"]);
  add("Nossa Senhora Aparecida (Feriado Nacional)", ["2026-10-12"]);
  add("Aniversário de Goiânia (Feriado no Tribunal e em todas as comarcas)", ["2026-10-24"]);
  add("Dia do Servidor Público (Feriado Estadual)", ["2026-10-28"]);
  add("Finados (Feriado Nacional)", ["2026-11-02"]);
  add("Proclamação da República (Feriado Nacional)", ["2026-11-15"]);
  add("Dia da Consciência Negra (Feriado Nacional)", ["2026-11-20"]);
  add("Dia da Justiça (Feriado — Art. 123 RITJGO)", ["2026-12-08"]);
  add("Natal (Feriado Nacional)", ["2026-12-25"]);
  addRange("Recesso Forense", "2026-12-20", "2027-01-20");

  // ---------- Helpers ----------
  function isWeekend(d){ const g = d.getDay(); return g===0 || g===6; }
  function isAshWednesday(d){ return ASH.has(ymd(d)); }
  function holidayInfo(d){ const k=ymd(d); return HOLIDAYS.get(k) || null; }

  function isHoliday(d, mode='counting'){
    const info = holidayInfo(d);
    if(info){
      if(isAshWednesday(d)){
        return mode === 'start_end' ? info : null;
      }
      return info;
    }
    return null;
  }

  function isBusinessDay(d, mode='counting'){
    if(isWeekend(d)) return false;
    const h = isHoliday(d, mode);
    if(h) return false;
    return true;
  }
  
  function nextBusinessDay(d, mode='counting'){
    let cur = new Date(d);
    while(!isBusinessDay(cur, mode)) cur = addDays(cur,1);
    return cur;
  }

  function reasonNonUseful(d, mode='counting'){
    const h = holidayInfo(d);
    if(h){
      if(h.name.toLowerCase().includes('recesso')) return 'Recesso forense';
      if(isAshWednesday(d) && mode==='start_end') return 'QF — não inicia/não finaliza';
      return `Feriado — ${h.name}`;
    }
    if(isWeekend(d)) return 'Fim de semana';
    if(isAshWednesday(d) && mode==='start_end') return 'QF — não inicia/não finaliza';
    return '';
  }

  function classifyDay(d, mode='counting'){
    const obj = {date: new Date(d), dow: diaSemana(d), tag: '', badge:'', obs:[], final:false};

    if(isWeekend(d)){
      obj.tag='Não útil'; obj.badge='warn';
      obj.obs.push('Fim de semana');
      return obj;
    }

    const h = isHoliday(d, mode);
    if(h){
      const isRec = h.name.toLowerCase().includes('recesso');
      obj.tag = isRec ? 'Recesso' : 'Não útil';
      obj.badge = isRec ? 'recesso' : 'warn';
      obj.obs.push(isRec ? 'Recesso forense' : h.name);
      if(isAshWednesday(d) && mode==='start_end'){ obj.obs = ['QF — não inicia/não finaliza']; obj.badge='info'; }
      return obj;
    }

    if(isAshWednesday(d) && mode==='counting'){
      obj.tag='Útil'; obj.badge='info'; obj.obs.push('QF — contado (contagem em curso)');
      return obj;
    }

    obj.tag='Útil'; obj.badge='ok';
    return obj;
  }

  function addBusinessDays(start, n, firstDayNote=null){
    let cur = new Date(start);
    let count = 0;
    const counted = new Map();
    while(count < n){
      cur = addDays(cur, 1);
      if(isBusinessDay(cur, 'counting')){
        count++;
        const obs = [`Dia útil de contagem #${count}`];
        if(count === 1 && firstDayNote){ obs[0] += ` (${firstDayNote})`; }
        if(count === n){ obs.push('Data teórica final do prazo'); }
        counted.set(ymd(cur), obs);
      }
    }
    if(isAshWednesday(cur)){
      const key = ymd(cur);
      if(counted.has(key)) counted.get(key).push('QF — não finaliza; prorrogado');
      let bump = nextBusinessDay(addDays(cur,1), 'start_end');
      counted.set(ymd(bump), ['Prorrogação da final por QF → Data final']);
      cur = bump;
    } else {
      const key = ymd(cur);
      if(counted.has(key)) counted.get(key).push('Data final do prazo');
      else counted.set(key, ['Data final do prazo']);
    }
    return {end: cur, counted};
  }

  function isRecessDay(d){
    const h = holidayInfo(d);
    return !!(h && h.name.toLowerCase().includes('recesso'));
  }

  function pushNote(map, d, txt){
    const k = ymd(d);
    if(!map.has(k)) map.set(k, []);
    map.get(k).push(txt);
  }

  function nextPublicationFrom(prevDate, pubIndex, pubLog){
    let d = addDays(prevDate, 1);
    while(true){
      const wknd = isWeekend(d);
      const h = holidayInfo(d);
      const rec = isRecessDay(d);

      if(wknd){
        pushNote(pubLog, d, 'ato de publicação não se realiza em finais de semana.');
        d = addDays(d, 1);
        continue;
      }

      if(h && !rec && !isAshWednesday(d)){
        pushNote(pubLog, d, `ato de publicação não se realiza em feriados — ${h.name}.`);
        d = addDays(d, 1);
        continue;
      }

      pushNote(pubLog, d, `Publicação D${pubIndex} (${pubIndex===1 ? '1º' : '2º'} dia útil após expedição)`);
      return d;
    }
  }

  // ---------- Função principal de cálculo ----------
  function calcularPrazo() {
    const tipo = document.getElementById('tipo').value;
    const sData = document.getElementById('dataBase').value;
    const nDias = parseInt(document.getElementById('dias').value, 10);
    
    if(!sData || isNaN(nDias) || nDias<=0){
      alert('Informe a Data Inicial e um número válido de dias.');
      return;
    }

    const marco = parseISO(sData);
    let D1=null, D2=null, inicioContagem=null, firstNote=null;
    const PUB_NOTES = new Map();

    if(tipo === 'leitura'){
      inicioContagem = nextBusinessDay(addDays(marco,1), 'start_end');
      firstNote = '1º dia útil após leitura';
    } else {
      D1 = nextPublicationFrom(marco, 1, PUB_NOTES);
      D2 = nextPublicationFrom(D1,    2, PUB_NOTES);
      inicioContagem = nextBusinessDay(addDays(D2,1), 'start_end');
      firstNote = 'dia útil subsequente à publicação D2';
    }

    const {end: dataFinal, counted} = addBusinessDays(addDays(inicioContagem,-1), nDias, firstNote);

    // Montar tabela
    const tbody = document.querySelector('#tabela tbody');
    tbody.innerHTML = '';
    let idx = 0;

    let cursor = new Date(marco);
    const endInclusive = new Date(dataFinal);

    while(cursor <= endInclusive){
      idx++;
      const key = ymd(cursor);
      const isMarco = (key === ymd(marco));
      let mode = (cursor < inicioContagem) ? 'start_end' : 'counting';

      const base = classifyDay(cursor, mode);
      const obsParts = [];

      if(base.tag === 'Não útil'){
        let reason = reasonNonUseful(cursor, mode);
        if(isMarco){
          const marcoTxt = (tipo==='leitura')?'Dia da leitura':'Dia da expedição';
          const isRecesso = (reason.toLowerCase().includes('recesso'));
          if(isRecesso){
            reason = 'Recesso forense — ' + marcoTxt;
            obsParts.push(reason);
          } else {
            obsParts.push(marcoTxt);
          }
        } else {
          obsParts.push(reason);
        }
      }

      if(PUB_NOTES && PUB_NOTES.has(key)){
        obsParts.push(...PUB_NOTES.get(key));
      }

      if(counted.has(key)){
        base.tag = 'Útil'; base.badge='ok';
        obsParts.push(...counted.get(key));
      }

      const tr = document.createElement('tr');
      const tdIdx = document.createElement('td'); tdIdx.textContent = idx;
      const tdData = document.createElement('td'); tdData.textContent = fmtBR(base.date);
      const tdDow  = document.createElement('td'); tdDow.textContent = base.dow;
      const tdTag  = document.createElement('td'); tdTag.innerHTML = `<span class="tag ${base.badge}">${base.tag}</span>`;
      const tdObs  = document.createElement('td'); tdObs.textContent = obsParts.join(' • ');
      tr.append(tdIdx, tdData, tdDow, tdTag, tdObs);

      if(key === ymd(dataFinal)) tr.style.outline = '2px solid var(--bad)';
      tbody.appendChild(tr);

      cursor = addDays(cursor,1);
    }

    document.getElementById('finalDate').innerHTML =
      `Prazo de <span class="code">${nDias}</span> dias úteis — <strong>data final:</strong> <span class="danger">${fmtBR(dataFinal)}</span>`;
    document.getElementById('resultado').style.display = 'block';

    // Copiar resumo
    document.getElementById('btnCopiar').onclick = ()=>{
      const resumo = [
        `Tipo: ${tipo === 'leitura' ? 'Leitura' : 'Expedição'}`,
        `Data Inicial: ${fmtBR(marco)}`,
        `Dias de prazo: ${nDias}`,
        `Data final: ${fmtBR(dataFinal)}`
      ].join('\n');
      navigator.clipboard.writeText(resumo).then(()=> alert('Resumo copiado.'));
    };

    // Exportar CSV
    document.getElementById('btnCSV').onclick = ()=>{
      const linhas = [["#", "Data", "Dia da semana", "Classificação", "Observação"]];
      const trs = document.querySelectorAll('#tabela tbody tr');
      trs.forEach(tr=>{
        const tds = tr.querySelectorAll('td');
        const cols = [tds[0].textContent, tds[1].textContent, tds[2].textContent, tds[3].innerText, tds[4].textContent];
        linhas.push(cols);
      });
      const csv = linhas.map(cols=> cols.map(col=> `"${String(col).replaceAll('"','""')}"`).join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'auditoria_prazo.csv';
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    };
  }

  // ---------- Inicialização ----------
  
  // 1. Chips de atalho (botões de 5, 15, 30 dias)
  document.querySelectorAll('.chip').forEach(ch => {
    ch.addEventListener('click', ()=>{
      document.getElementById('dias').value = ch.dataset.d;
      // Opcional: focar no botão calcular após escolher o chip
      document.getElementById('btnCalcular').focus(); 
    });
  });

  // 2. Botão calcular (Clique do Mouse)
  document.getElementById('btnCalcular').addEventListener('click', calcularPrazo);

  // 3. Navegação via Teclado (Tecla Enter em qualquer campo dispara o cálculo)
  const inputsNavegaveis = ['dataBase', 'dias', 'tipo'];
  inputsNavegaveis.forEach(id => {
    document.getElementById(id).addEventListener('keypress', function(e){
      if(e.key === 'Enter'){
        e.preventDefault(); 
        document.getElementById('btnCalcular').click();
      }
    });
  });

  // 4. Correção para COLAR data (Paste)
  // O campo date padrão exige yyyy-mm-dd. Se o usuário colar dd/mm/yyyy, convertemos.
  const inputData = document.getElementById('dataBase');
  inputData.addEventListener('paste', function(e) {
    // Tenta pegar o texto colado
    const paste = (e.clipboardData || window.clipboardData).getData('text');
    
    // Expressão regular para identificar formato BR (dd/mm/aaaa ou dd-mm-aaaa)
    // Aceita separadores / ou -
    const regexBR = /^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/;
    
    if (regexBR.test(paste)) {
      e.preventDefault(); // Impede o comportamento padrão (que falharia)
      
      // Converte para o formato ISO (yyyy-mm-dd)
      const partes = paste.split(/[\/\-]/); // Quebra em dia, mes, ano
      const dia = partes[0].padStart(2, '0');
      const mes = partes[1].padStart(2, '0');
      const ano = partes[2];
      
      this.value = `${ano}-${mes}-${dia}`;
    }
  });

  // 5. Toggle informações legais
  document.getElementById('legalToggle').addEventListener('click', function(){
    this.classList.toggle('open');
    document.getElementById('legalContent').classList.toggle('show');
  });

  // 6. Data padrão: hoje
  const today = new Date();
  const todayFormatted = today.toISOString().split('T')[0];
  document.getElementById('dataBase').value = todayFormatted;
</script>
  
</body>
</html>
